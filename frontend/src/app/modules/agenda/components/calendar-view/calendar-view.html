<div class="flex flex-col h-full bg-surface-light dark:bg-surface-dark relative">

    <!-- MONTH VIEW -->
    <ng-container *ngIf="view === 'month'">
        <!-- Header: Week Days -->
        <div class="grid grid-cols-7 border-b border-border-light dark:border-border-dark">
            <div *ngFor="let dayName of ['LUN','MAR','MIÉ','JUE','VIE','SÁB','DOM']"
                class="py-3 text-center text-xs font-semibold text-slate-500 dark:text-slate-400">
                {{ dayName }}
            </div>
        </div>

        <!-- Body: Month Grid -->
        <div class="flex-1 grid grid-cols-7 grid-rows-6 bg-border-light dark:bg-border-dark gap-[1px]">
            <div *ngFor="let day of monthDays"
                class="bg-surface-light dark:bg-surface-dark p-1 flex flex-col gap-1 min-h-[80px] hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors cursor-pointer group relative"
                [ngClass]="{'opacity-50 bg-slate-50/50 dark:bg-slate-900/50': !day.isCurrentMonth, 'ring-1 ring-inset ring-primary': isToday(day.date)}"
                (click)="handleMonthDayClick(day.date)">

                <span class="text-xs font-medium ml-1 mt-1 w-6 h-6 flex items-center justify-center rounded-full"
                    [ngClass]="{'bg-primary text-white': isToday(day.date), 'text-slate-700 dark:text-slate-300': !isToday(day.date)}">
                    {{ day.date.getDate() }}
                </span>

                <!-- Appointment Count Summary -->
                <div *ngIf="day.events.length > 0" class="flex items-center justify-center h-full pb-6">
                    <div
                        class="px-3 py-1 bg-primary/10 text-primary rounded-full text-xs font-bold shadow-sm group-hover:bg-primary group-hover:text-white transition-colors">
                        {{ day.events.length }} Citas
                    </div>
                </div>
            </div>
        </div>
    </ng-container>

    <!-- DAY & WEEK VIEW -->
    <ng-container *ngIf="view !== 'month'">
        <div class="flex flex-col h-full">
            <!-- Header: Days -->
            <div class="flex border-b border-border-light dark:border-border-dark min-h-[60px]">
                <!-- Time Column Header (Empty) -->
                <div
                    class="w-16 flex-shrink-0 border-r border-border-light dark:border-border-dark bg-slate-50 dark:bg-slate-800/50">
                </div>

                <!-- Days Columns -->
                <div class="flex-1 grid divide-x divide-border-light dark:divide-border-dark"
                    [style.grid-template-columns]="'repeat(' + weekDays.length + ', minmax(0, 1fr))'">
                    <div *ngFor="let day of weekDays"
                        class="flex flex-col items-center justify-center py-2 transition-colors"
                        [ngClass]="{'bg-primary/10 dark:bg-primary/20 border-b-2 border-primary': isToday(day.date), 'bg-slate-50 dark:bg-slate-800/50': !isToday(day.date)}">
                        <span class="text-xs font-semibold uppercase"
                            [ngClass]="{'text-primary': isToday(day.date), 'text-slate-500 dark:text-slate-400': !isToday(day.date)}">
                            {{ day.name }}
                        </span>
                        <div class="w-8 h-8 flex items-center justify-center rounded-full text-sm font-bold mt-1 shadow-sm"
                            [ngClass]="{'bg-primary text-white shadow-primary/30': isToday(day.date), 'text-slate-700 dark:text-slate-200': !isToday(day.date)}">
                            {{ day.dayNumber }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Body: Scrollable Grid -->
            <div class="flex-1 overflow-y-auto relative custom-scrollbar">
                <div class="flex min-h-[800px]"> <!-- Set min-height to ensure scroll -->

                    <!-- Time Column -->
                    <div
                        class="w-16 flex-shrink-0 flex flex-col border-r border-border-light dark:border-border-dark text-xs text-slate-400 font-medium bg-slate-50 dark:bg-slate-800/30">
                        <div *ngFor="let time of hours"
                            class="h-20 border-b border-border-light dark:border-border-dark flex justify-center pt-2">
                            {{ time }}
                        </div>
                    </div>

                    <!-- Grid Columns -->
                    <div class="flex-1 grid divide-x divide-border-light dark:divide-border-dark relative"
                        [style.grid-template-columns]="'repeat(' + weekDays.length + ', minmax(0, 1fr))'">

                        <!-- Vertical Day Columns with Slots -->
                        <div *ngFor="let day of weekDays; let i = index" class="relative group"
                            [ngClass]="{'bg-primary/5 dark:bg-primary/10': isToday(day.date), 'bg-white dark:bg-surface-dark': !isToday(day.date)}">

                            <!-- Background Lines -->
                            <div class="absolute inset-0 flex flex-col pointer-events-none">
                                <div *ngFor="let time of hours"
                                    class="h-20 border-b border-slate-100 dark:border-slate-800 border-dashed">
                                </div>
                            </div>

                            <!-- Clickable Background Slots (e.g. per hour) -->
                            <div *ngFor="let slot of hours" class="h-20 hover:bg-primary/5 cursor-pointer relative z-0"
                                (click)="handleSlotClick(day.date, slot)">
                            </div>

                            <!-- Current Time Indicator -->
                            <div *ngIf="isToday(day.date)"
                                class="absolute w-full border-t-2 border-red-500 z-20 pointer-events-none flex items-center"
                                [style.top.%]="currentTimePercentage">
                                <div class="w-2 h-2 rounded-full bg-red-500 -ml-1"></div>
                                <div
                                    class="absolute right-0 text-[10px] font-bold bg-white text-red-500 border border-red-500 px-1 rounded transform translate-x-full ml-1">
                                    {{ currentTime }}
                                </div>
                            </div>

                            <!-- Appointments Rendering -->
                            <ng-container *ngFor="let appt of getAppointmentsForDay(day.date)">
                                <div class="absolute inset-x-1 rounded-md p-2 border-l-[3px] cursor-pointer hover:shadow-lg hover:z-50 hover:scale-[1.02] transition-all z-10 overflow-hidden group shadow-sm hover:h-auto hover:min-h-fit"
                                    [ngClass]="getAppointmentClasses(appt)" [style.top.px]="getApptTop(appt.startTime)"
                                    [style.height.px]="getApptHeight(appt.startTime, appt.endTime)"
                                    (click)="$event.stopPropagation(); handleAppointmentClick(appt)">

                                    <!-- Top Row: Title & Status Icon -->
                                    <div class="flex justify-between items-start gap-1">
                                        <span
                                            class="text-xs font-bold truncate tracking-tight text-gray-800 dark:text-gray-100 group-hover:text-primary transition-colors">
                                            {{ appt.title || 'Sin Título' }}
                                        </span>

                                        <!-- Status Icons/Chips -->
                                        <div class="flex items-center" [ngSwitch]="appt.status">
                                            <span *ngSwitchCase="'CONFIRMED'"
                                                class="material-symbols-outlined text-[14px] text-green-600"
                                                title="Confirmada">check_circle</span>
                                            <span *ngSwitchCase="'PENDING'"
                                                class="material-symbols-outlined text-[14px] text-amber-500"
                                                title="Pendiente">schedule</span>
                                            <span *ngSwitchCase="'CANCELLED'"
                                                class="material-symbols-outlined text-[14px] text-red-500"
                                                title="Cancelada">cancel</span>
                                            <span *ngSwitchCase="'COMPLETED'"
                                                class="material-symbols-outlined text-[14px] text-blue-600"
                                                title="Realizada">task_alt</span>
                                        </div>
                                    </div>

                                    <!-- Notes / Description -->
                                    <p class="text-[10px] font-medium mt-0.5 truncate text-gray-500 dark:text-gray-400">
                                        {{ appt.notes || 'Consulta General' }}
                                    </p>

                                    <!-- Doctor -->
                                    <div *ngIf="appt.dentist"
                                        class="flex items-center gap-1 mt-0.5 text-[10px] text-primary dark:text-teal-400 font-medium truncate">
                                        <span class="material-symbols-outlined text-[10px]">dentistry</span>
                                        Dr. {{ appt.dentist.name }}
                                    </div>

                                    <!-- Time Range (Bottom) -->
                                    <div
                                        class="flex items-center gap-1 mt-1.5 text-[10px] text-gray-400 font-semibold opacity-90">
                                        <span class="material-symbols-outlined text-[10px]">schedule</span>
                                        {{ appt.startTime | date:'HH:mm' }} - {{ appt.endTime | date:'HH:mm' }}
                                    </div>
                                </div>
                            </ng-container>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </ng-container>
</div>