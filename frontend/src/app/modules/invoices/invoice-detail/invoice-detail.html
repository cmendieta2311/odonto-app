<div *ngIf="isLoading" class="flex-1 p-8 flex items-center justify-center">
    <div class="flex flex-col items-center gap-4">
        <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
        <p class="text-[#618389]">Cargando factura...</p>
    </div>
</div>

<div *ngIf="!isLoading && invoice" class="flex-1 p-4 lg:p-8 max-w-[1400px] mx-auto w-full flex flex-col gap-6">
    <div>
        <a [routerLink]="['/admin/invoices']"
            class="flex items-center text-sm font-medium text-[#618389] hover:text-primary transition-colors w-fit">
            <span class="material-symbols-outlined text-[20px] mr-1">arrow_back</span>
            Volver al listado de facturas
        </a>
    </div>

    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <div class="flex items-center gap-3 flex-wrap">
                <h1 class="text-[#111718] dark:text-white text-3xl font-extrabold tracking-tight">{{ isReceipt ?
                    'Recibo' : 'Factura' }}
                    {{invoice.number || invoice.id}}
                </h1>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium"
                    [ngClass]="getStatusClass(invoice.status)">
                    {{invoice.status}}
                </span>
            </div>
            <p class="text-[#618389] text-sm font-medium mt-1">Generada el {{invoice.issuedAt | date:'mediumDate'}}</p>
        </div>
        <div class="flex flex-wrap gap-3 w-full md:w-auto">
            <button
                class="flex-1 md:flex-none flex items-center justify-center gap-2 h-10 px-4 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 dark:border-red-900/50 dark:text-red-400 dark:hover:bg-red-900/20 transition-colors text-sm font-bold">
                <span class="material-symbols-outlined text-[20px]">block</span>
                <span>Anular</span>
            </button>
            <button
                class="flex-1 md:flex-none flex items-center justify-center gap-2 h-10 px-4 rounded-lg border border-gray-200 bg-white dark:bg-[#1a2c30] dark:border-gray-700 text-[#111718] dark:text-white text-sm font-bold hover:bg-gray-50 dark:hover:bg-white/5 transition-colors shadow-sm">
                <span class="material-symbols-outlined text-[20px]">mail</span>
                <span>Enviar Email</span>
            </button>
            <button (click)="downloadPdf()"
                class="flex-1 md:flex-none flex items-center justify-center gap-2 h-10 px-4 rounded-lg bg-primary text-white text-sm font-bold shadow-md hover:bg-primary/90 transition-colors">
                <span class="material-symbols-outlined text-[20px]">download</span>
                <span>Descargar PDF</span>
            </button>
        </div>
    </div>

    <!-- Invoice Layout -->
    <div *ngIf="!isReceipt" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 flex flex-col gap-6">
            <div
                class="bg-white dark:bg-[#1a2c30] rounded-xl border border-gray-200 dark:border-gray-800 shadow-sm p-6 md:p-10 print:shadow-none">
                <!-- Header Info -->
                <div
                    class="flex flex-col md:flex-row justify-between border-b border-gray-100 dark:border-gray-800 pb-8 mb-8">
                    <div class="flex flex-col gap-1">
                        <div class="flex items-center gap-2 mb-4">
                            <div class="size-8 text-primary">
                                <span class="material-symbols-outlined text-3xl">dentistry</span>
                            </div>
                            <span class="text-xl font-bold text-[#111718] dark:text-white">DentalApp</span>
                        </div>
                        <p class="text-sm text-gray-500">Av. Principal 123, Consultorio 402</p>
                        <p class="text-sm text-gray-500">Ciudad de México, CP 11560</p>
                        <p class="text-sm text-gray-500">RFC: DENT123456APP</p>
                        <p class="text-sm text-gray-500">Tel: +52 55 1234 5678</p>
                    </div>
                    <div class="mt-6 md:mt-0 text-left md:text-right">
                        <h2 class="text-2xl font-bold text-[#111718] dark:text-white mb-1">FACTURA</h2>
                        <p class="text-primary font-bold text-lg mb-4">{{invoice.number || invoice.id}}</p>
                        <div class="flex flex-col md:items-end gap-1">
                            <div class="flex justify-between md:justify-end gap-4 text-sm">
                                <span class="text-gray-500">Fecha de Emisión:</span>
                                <span class="font-medium text-[#111718] dark:text-white">{{invoice.issuedAt |
                                    date:'mediumDate'}}</span>
                            </div>
                            <div class="flex justify-between md:justify-end gap-4 text-sm">
                                <span class="text-gray-500">Vencimiento:</span>
                                <span class="font-medium text-[#111718] dark:text-white">{{invoice.dueDate |
                                    date:'mediumDate'}}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bill To -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div>
                        <h3 class="text-xs font-bold text-[#618389] uppercase tracking-wider mb-4">Facturado a
                            (Paciente)</h3>
                        <div class="flex items-start gap-4">
                            <div
                                class="h-12 w-12 rounded-full bg-cover bg-center border border-gray-200 shrink-0 shadow-sm bg-gray-100">
                                <span *ngIf="!invoice.patient?.image"
                                    class="flex items-center justify-center h-full w-full text-gray-400 material-symbols-outlined">person</span>
                            </div>
                            <div>
                                <p class="text-lg font-bold text-[#111718] dark:text-white">
                                    {{invoice.patient?.firstName}} {{invoice.patient?.lastName}}</p>
                                <p class="text-sm text-gray-500">{{invoice.patient?.address || 'Dirección no
                                    registrada'}}</p>
                                <p class="text-sm text-gray-500">{{invoice.patient?.email}}</p>
                                <p
                                    class="text-sm text-gray-500 mt-1 font-medium bg-gray-50 dark:bg-white/5 inline-block px-2 py-0.5 rounded">
                                    DNI: {{invoice.patient?.dni}}</p>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-gray-50 dark:bg-[#101f22] p-5 rounded-xl border border-gray-100 dark:border-gray-800">
                        <h3 class="text-xs font-bold text-[#618389] uppercase tracking-wider mb-3">Referencias del
                            Sistema</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between text-sm items-center">
                                <span class="text-gray-500">Contrato:</span>
                                <a class="font-medium text-primary hover:underline flex items-center gap-1" href="#">
                                    {{invoice.contractId || 'N/A'}}
                                    <span class="material-symbols-outlined text-[14px]">open_in_new</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Items Table -->
                <div class="mb-8 overflow-hidden rounded-lg border border-gray-200 dark:border-gray-800">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 dark:bg-[#101f22]">
                            <tr>
                                <th
                                    class="py-3 px-4 text-left font-semibold text-[#618389] uppercase text-xs tracking-wider">
                                    Descripción</th>
                                <th
                                    class="py-3 px-4 text-center font-semibold text-[#618389] uppercase text-xs tracking-wider">
                                    Cant.</th>
                                <th
                                    class="py-3 px-4 text-right font-semibold text-[#618389] uppercase text-xs tracking-wider">
                                    Precio Unit.</th>
                                <th
                                    class="py-3 px-4 text-right font-semibold text-[#618389] uppercase text-xs tracking-wider">
                                    Total</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
                            <tr *ngFor="let item of invoice.items">
                                <td class="py-4 px-4 text-[#111718] dark:text-white">
                                    <p class="font-bold">{{item.description}}</p>
                                </td>
                                <td class="py-4 px-4 text-center text-gray-600 dark:text-gray-400">{{item.quantity}}
                                </td>
                                <td class="py-4 px-4 text-right text-gray-600 dark:text-gray-400">{{item.unitPrice |
                                    currency}}</td>
                                <td class="py-4 px-4 text-right font-bold text-[#111718] dark:text-white">{{item.total |
                                    currency}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Totals -->
                <div class="flex flex-col md:flex-row justify-between items-start gap-8">
                    <div
                        class="flex-1 bg-primary/5 dark:bg-[#1a2c30]/50 p-4 rounded-lg border border-primary/20 dark:border-gray-800">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-primary text-[18px]">info</span>
                            <p class="text-xs font-bold text-[#618389] uppercase tracking-wider">Notas</p>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 italic">Gracias por su pago puntual. Este
                            documento es un comprobante fiscal válido para deducción de impuestos según la normativa
                            vigente.</p>
                    </div>
                    <div class="w-full md:w-72 flex flex-col gap-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500 font-medium">Subtotal:</span>
                            <span class="font-medium text-[#111718] dark:text-white">{{invoice.amount |
                                currency}}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500 font-medium">Impuestos (IVA 0%):</span>
                            <span class="font-medium text-[#111718] dark:text-white">{{0 | currency}}</span>
                        </div>
                        <div class="h-px bg-gray-200 dark:bg-gray-700 my-1"></div>
                        <div class="flex justify-between text-xl font-extrabold items-end">
                            <span class="text-[#111718] dark:text-white text-base mb-1">Total:</span>
                            <span class="text-primary">{{invoice.amount | currency}}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Info -->
        <div class="lg:col-span-1 flex flex-col gap-6">
            <!-- Payment Details Card -->
            <div
                class="bg-white dark:bg-[#1a2c30] rounded-xl border border-gray-200 dark:border-gray-800 shadow-sm p-6">
                <div class="flex items-center gap-2 mb-5">
                    <span class="material-symbols-outlined text-primary">payments</span>
                    <h3 class="font-bold text-[#111718] dark:text-white text-lg">Estado del Pago</h3>
                </div>

                <div class="flex flex-col gap-4">
                    <div class="p-4 rounded-lg" [ngClass]="getStatusClass(invoice.status)">
                        <p class="font-bold text-center">{{invoice.status}}</p>
                    </div>

                    <div class="flex justify-between text-sm py-2 border-b border-gray-100 dark:border-gray-800">
                        <span class="text-gray-500">Monto Total:</span>
                        <span class="font-bold">{{invoice.amount | currency}}</span>
                    </div>
                    <div class="flex justify-between text-sm py-2">
                        <span class="text-gray-500">Saldo Pendiente:</span>
                        <span class="font-bold text-red-500">{{invoice.balance | currency}}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt Layout -->
    <div *ngIf="isReceipt" class="flex flex-col items-center">
        <div
            class="bg-white dark:bg-[#1a2c30] rounded-xl border border-gray-200 dark:border-gray-800 shadow-sm p-8 md:p-12 max-w-4xl w-full">
            <!-- Receipt Header -->
            <div
                class="flex flex-col md:flex-row justify-between mb-8 pb-8 border-b border-gray-100 dark:border-gray-700">
                <!-- Left: Clinic Info -->
                <div>
                    <img *ngIf="clinicConfig?.logoUrl" [src]="clinicConfig.logoUrl"
                        class="h-16 w-auto object-contain mb-3" alt="Logo">
                    <h2 class="text-2xl font-bold text-primary mb-2">{{ clinicConfig?.businessName || 'Dental Manager'
                        }}</h2>
                    <p class="text-sm text-gray-500 leading-relaxed">
                        <span *ngIf="clinicConfig?.ruc" class="block">RUC: {{ clinicConfig.ruc }}</span>
                        <span *ngIf="clinicConfig?.address" class="block">{{ clinicConfig.address }}</span>
                        <span *ngIf="clinicConfig?.phone" class="block">Tel: {{ clinicConfig.phone }}</span>
                        <span *ngIf="clinicConfig?.email" class="block">{{ clinicConfig.email }}</span>
                    </p>
                </div>
                <!-- Right: Receipt Title -->
                <div class="text-right mt-6 md:mt-0">
                    <h1 class="text-3xl font-extrabold text-[#111718] dark:text-white tracking-tight text-gray-900">
                        RECIBO DE DINERO</h1>
                    <p class="text-lg font-bold text-gray-500 mt-1">NO. {{invoice.number || invoice.id}}</p>
                    <p class="text-sm text-gray-400 mt-1">Fecha: {{invoice.issuedAt | date:'mediumDate'}}</p>
                </div>
            </div>

            <!-- Receipt Body -->
            <div class="flex flex-col gap-6">
                <!-- Row 1: Amount -->
                <div class="flex flex-col md:flex-row md:items-center gap-2">
                    <span class="w-32 font-bold text-gray-500">Monto:</span>
                    <div
                        class="flex-1 bg-gray-50 dark:bg-gray-800/50 p-3 rounded-lg border border-gray-100 dark:border-gray-700">
                        <span class="text-xl font-bold text-[#111718] dark:text-white">{{ invoice.amount |
                            currency:'PYG':'symbol-narrow':'1.0-0' }}</span>
                    </div>
                </div>

                <!-- Row 2: Received From -->
                <div class="flex flex-col md:flex-row md:items-center gap-2">
                    <span class="w-32 font-bold text-gray-500">Recibí de:</span>
                    <div
                        class="flex-1 border-b border-dotted border-gray-300 dark:border-gray-600 pb-1 text-lg text-[#111718] dark:text-white">
                        <span class="font-medium">{{invoice.patient?.firstName}} {{invoice.patient?.lastName}}</span>
                        <span *ngIf="invoice.patient?.dni" class="ml-2 text-sm text-gray-500">(CI:
                            {{invoice.patient?.dni}})</span>
                    </div>
                </div>

                <!-- Row 3: Concept -->
                <div class="flex flex-col md:flex-row md:items-start gap-2">
                    <span class="w-32 font-bold text-gray-500 mt-1">En concepto de:</span>
                    <div
                        class="flex-1 bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg italic text-gray-600 dark:text-gray-300 border border-gray-100 dark:border-gray-700 min-h-[80px]">
                        <ng-container *ngIf="invoice.items?.length; else defaultConcept">
                            <span *ngFor="let item of invoice.items; let last = last">{{item.description}}{{!last ? ', '
                                : ''}}</span>
                        </ng-container>
                        <ng-template #defaultConcept>Pago de servicios profesionales</ng-template>
                    </div>
                </div>
            </div>

            <!-- Signature Section -->
            <div class="mt-16 flex justify-center">
                <div class="flex flex-col items-center gap-2 w-64">
                    <div class="h-px bg-gray-300 w-full"></div>
                    <p class="text-sm font-bold text-gray-500">Firma y Aclaración</p>
                    <p class="text-xs text-gray-400">{{ clinicConfig?.businessName || 'Dental Manager' }}</p>
                </div>
            </div>

        </div>
    </div>
</div>